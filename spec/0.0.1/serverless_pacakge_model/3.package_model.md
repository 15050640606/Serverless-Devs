# Pacakge 模型

Pacakge 模型部分介绍了 Serverless Package Model (SPM) 的建设模型，包括了：

- 模型的组成
- 模型的规范

## 模型的组成

Serverless Package Model 包括两个部分：

- Component Model：组件模型，即通过Serverless Devs，可以被应用所引用，并按照用户的输入，执行预定的功能。例如某个应用中引用了FC组件，那么此时，用户可以通过传入Deploy命令进行函数的部署，而这里的FC组件，则是需要建立在组件模型基础之上，即要符合组件的开发规范；
- Application Model：应用模型，即通过Serverless Devs，可以被初始化的应用案例，通常一个应用案例包括了一个yaml文件，在该文件中可以包括一个或多个组件来共同完成某个业务。这里所说的应用，就是需要建立在应用模型基础之上的，或者说是需要符合应用开发规范的；

## 模型的规范

### 组件模型规范

Component Model，即组件模型是需要通过指定的文件进行模型的规范和定义的。在这里，推荐的组件模型目录结构为：

```
|- src # 目录名字可以变更
|   └── 代码目录  
|- package.json: 需要定义好main   
|- publish.yaml: 项目的资源描述   
|- readme.md: 项目简介  
|- version.md: 版本更新内容
```

其中：

| 目录 | 必须 | 含义 |
| --- | --- | --- |
| src | 推荐存在 | 统一放置功能实现，当然也可以换成其他的名称，或者平铺到项目下，但是推荐通过src来做统一的存放 |
| package.json | 必须存在 |  Node.js的package.json，需要描述清楚组件的入口文件位置  |
| publish.yaml | 必须存在 | Serverless Devs Package的开发识别文档  |
| readme.md | 必须存在 | 对该组件的描述，或帮助文档信息  |
| version.md| 推荐存在 | 版本的描述，例如当前版本的更新内容等 |


#### 组件模型元数据

组件模型元数据将会在`publish.yaml`中进行描述，并在Serverless Registry和Serverless Devs开发者工具侧进行识别和引用。

`publish.yaml`文件的基本格式如下所示：

```yaml
Type: Component
Name: 名称
Provider:
  - 云厂商名称 
Version: 版本，例如0.0.1
Description: 简短的描述/介绍
HomePage: 项目首页地址
Tags: #标签详情
  - 部署函数
  - 部署组件
Category: 分类 # 基础云服务/Web框架/Web应用/人工智能/音视频处理/图文处理/监控告警/大数据/IoT/新手入门/其他
Service: # 使用的服务
  - Name: 服务名 # 函数计算/容器服务/镜像服务/消息队列/工作流/CDN/对象存储/表格存储/MNS/日志服务/API网关/数据库/解析服务/云应用/其他
    # Runtime: Python 3.6 如果服务是函数，还需要增加Runtime
    Authorities: #权限描述
      - 创建函数 # 所需要的权限
Commands: # 指令，格式为指令：指令描述，例如：
  deploy: 部署函数
  invoke: 调用函数
Properties:
  Region: # 参数
    Description: 参数描述
    Required: true # 参数必选，true/false
    Type: # 参数类型
      - String
```

##### 参数详解

| 目录 | 必须 | 结构 | 含义 |
| --- | --- | --- | --- |
| Type | 是 | String | 类型，包括Component和Application两个取值，此处取值Component |
| Name | 是 | String | 组件名称 |
| Provider | 是 | List<String> | 组件所支持的云厂商信息 |
| Version | 是 | String | 组件版本号，例如0.0.1 |
| Description | 是 | String | 组件描述（一句话的简短描述） |
| HomePage | 否 | String | 组件的主页，可以填写组件的仓库地址 |
| Tags | 否 | List<String> | 组件的标签 |
| Category | 是 | String | 组件的分类 |
| Service | 是 | Struct | 组件所需要的服务和相关的权限等描述，例如该组件需要函数计算，Serverless工作流等产品/服务作为支持 |
| Commands | 是 | Struct | 组件支持的命令 |
| Properties | 是 | Struct | 组件的参数描述，组件的属性定义 |

###### Provider

取值范围：`阿里云`, `百度智能云`, `华为云`, `腾讯云`, `AWS`, `Azure`, `Google Cloud`, `其它`

格式参考：
```yaml
Provider:
    - 阿里云
    - 百度智能云
```

###### Category

取值范围：`基础云服务`, `Web框架`, `全栈应用`, `人工智能`, `音视频处理`, `图文处理`, `监控告警`, `大数据`, `IoT`, `新手入门`, `其他`

格式参考：
```yaml
Category: 基础云服务
```

###### Service

取值范围：`函数计算`, `容器服务`, `镜像服务`, `消息队列`, `工作流`, `CDN`, `对象存储`, `表格存储`, `MNS`, `日志服务`, `API网关`, `数据库`, `解析服务`, `云应用`, `其他`

格式参考：
```yaml
Service: # 使用的服务
  - Name: 函数计算
    # Runtime: Python 3.6 如果服务是函数，还需要增加Runtime，取值包括：Node.JS, Python, PHP, Java, Go, 其它
    Authorities: #权限描述
      - 创建函数 # 所需要的权限
```

###### Properties

Properties是对组件的属性进行描述的，所以相对比较负责，主要包括：

| 目录 | 必须 | 结构 | 含义 |
| --- | --- | --- | --- |
| Description | 是 | String | 参数描述 |
| Required | 是 | String | 是否必须 |
| Type | 是 | Struct | 参数类型 |
| Example | 否 | String | 参数举例 |
| Default | 否 | String | 参数默认值 |

关于参数Type(类型)的额外定义：

基本参数类型：`String`, `Number`, `List`, `Enum`, `Struct`, `Boolean`, `Null`, `Any`    
复杂参数类型：`List<数据类型>`   

另外，当Type是List类型时，可以针对不同的元素做别名：`数据类型[别名]`

格式参考：
- 简单格式：
    ```yaml
    Properties:
      Region: # 参数
        Description: 参数描述
        Required: true # 参数必选，true/false
        Type: # 参数类型
          - String
    ```
  用户侧表现是：
   ```yaml
   Region: cn-hangzhou
   ```
- 复杂格式：
    ```yaml
    Properties:
      Region: # 参数
        Description: 地区
        Required: true # 参数必选，true/false
        Type: # 参数类型
          - String[简单配置]
          - List<String>[多地域配置]
          - Struct[分别配置]: 
              APIGW:
                Description: API网关部署的地区
                Required: true 
                Type: 
                  - String
              Function:
                Description: 函数部署的地区
                Required: true 
                Type: 
                  - String
    ```
  用户侧表现是：
  - 当Type为String[简单配置]时：
    ```yaml
    Region: cn-hangzhou
    ```
  - 当Type为List<String>[多地域配置]时：
    ```yaml
    Region: 
      - cn-hangzhou
      - cn-beijing
    ```
  - 当Type为Struct[分别配置]时：
    ```yaml
    Region: 
      APIGW: cn-beijing
      Function: cn-shanghai
    ```    
    
    
#### 组件模型代码形式

在组件模型中，是需要组件开发者实现对应的功能。例如函数计算组件需要具备部署业务的功能，那么此时部署功能需要组件开发者进行定义并实现。

例如，组件开发者定义的部署功能为deploy方法，并实现了一个deploy方法，此时当用户使用该组件时，系统就会寻找到该组件的deploy方法进行调用。

组件的方法通常为：

```typescript
import logger from './common/logger';
import { InputProps } from './common/entity';

export default class ComponentDemo {
  /**
   * demo 实例
   * @param inputs
   * @returns
   */
  public async test(inputs: InputProps) {
    logger.debug(`input: ${JSON.stringify(inputs.props)}`);
    logger.info('command test');
    return { hello: 'world' };
  }
}
```

在上面的案例代码中，可以看到有一个test方法，该方法就是功能实现的方法。此时当用户使用test命令时，系统就会携带参数调用该方法。

例如，该组件名为`hexo`，组件核心代码如上所示，具备一个test方法，此时用户侧的Yaml为：

```yaml
edition: 1.0.0        #  命令行YAML规范版本，遵循语义化版本（Semantic Versioning）规范
name: FullStack       #  项目名称
access: xxx-account1  #  秘钥别名

services:
  HexoComponent:
    component: hexo
    props:
      region: 'cn-hangzhou'
      codeUri: './src'
```

当用户执行`s test mytest -a -b abc`，此时，组件代码中的`test`方法，收到的`inputs`参数实际上是：

```
{
    "command": 'deploy', 
    "project": {
        projectName: 'HexoComponent', 
        component: 'hexo',
        provider: 'alibaba',
        access：'release'
    },
    "credentials": {
        "AccountID": "********",
        "AccessKeyID": "********",
        "AccessKeySecret": "********",
    },
    "prop": {
        "Region": "cn-hangzhou",
        "CodeUri": "./src"
    },
    "args": "mytest -a -b abc",
    "argsObj": {}
}
```


### 应用模型规范

#### 开发规范

以下开发规范仅是测试版的规范（但是之后的规范会兼容这套规范），规范会在后期不断完善，也期待您可以给我们更多的意见、建议。

项目目录必须遵守以下格式：

```
|- src # 目录名字不可变更
|   └── 应用目录  
|- publish.yaml: 项目的资源描述   
|- readme.md: 项目简介  
|- version.md: 版本更新内容
```
#### publish.yaml

这个文件是项目的描述文档。系统将会在您发布资源的时候，读取该文档并且进行相关信息的录入，请您务必认真填写。

```yaml
Type: Application
Name: 名称
Provider:
  - 云厂商名称 # Alibaba/Baidu/Huawei/AWS/Google Cloud/Azure/Vercel/Tencent
Version: 版本，例如0.0.1
Description: 
  zh: 简短的描述/介绍
  en: English
HomePage: 项目首页地址
Tags: #标签详情
  - 部署函数
Category: 分类 # 基础云服务/Web框架/Web应用/人工智能/音视频处理/图文处理/监控告警/大数据/IoT/新手入门/其他
Service: # 使用的服务
  - Name: 服务名 # 函数计算/容器服务/镜像服务/消息队列/工作流/CDN/对象存储/表格存储/MNS/日志服务/API网关/数据库/解析服务/云应用/其他
    # Runtime: Python 3.6 如果服务是函数，还需要增加Runtime
    Authorities: #权限权限
      - 创建函数 # 所需要的权限
```

部分参数取值范围：

* 云厂商：
    ```阿里云, 百度智能云, 华为云, 腾讯云, AWS, Azure, Google Cloud, /其它```
    
* 分类：
    ```基础云服务, Web框架, 全栈应用, 人工智能, 音视频处理, 图文处理, 监控告警, 大数据, IoT, 新手入门, 其他```
    
* 云厂商：
    ```函数计算, 容器服务, 镜像服务, 消息队列, 工作流, CDN, 对象存储, 表格存储, MNS, 日志服务, API网关, 数据库, 解析服务, 云应用, 其他```
    
* 运行时：
    ```Node.JS, Python, PHP, Java, Go, 其它```

##### readme.md

这个文件是项目的简介，您可以通过这部分，为您的项目写一份完整的描述文档，这样大家在使用您的项目的时候，才可以更加简单，轻松快速的用的起来。

##### version.md

这个版本升级的描述文档，可以在这个文档介绍版本升级的内容

#### 项目流程

本例子仅是一个开发样例，尽可能的为您描述清楚每个开发细节。如果有任何问题可以随时和我取得联系（Wechat：anycodes_02）

在命令行执行：`s init`，选择`Application`选项即可创建初始化项目。